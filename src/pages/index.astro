---
import Layout from '../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
---

<Layout title="Ingreso - CobroDigital">
  <div class="min-h-screen bg-slate-50 flex items-center justify-center p-6">
    <div class="bg-white w-full max-w-5xl rounded-[3.5rem] shadow-2xl shadow-blue-100 flex flex-col md:flex-row overflow-hidden border border-white">
      
      <div class="w-full md:w-1/2 bg-gradient-to-br from-blue-600 to-indigo-700 p-12 flex flex-col justify-center items-center text-center relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-400/20 rounded-full -ml-20 -mb-20 blur-3xl"></div>

        <div class="relative">
          <div class="bg-white/10 backdrop-blur-md p-8 rounded-[3rem] border border-white/20 mb-8 inline-block shadow-2xl">
            <Icon name="lucide:wallet" class="w-20 h-20 text-white" />
          </div>
          <h2 class="text-4xl font-black text-white leading-tight mb-4 tracking-tighter">
            Control Total <br/> en tus manos
          </h2>
          <p class="text-blue-100 font-medium max-w-xs mx-auto text-sm opacity-80">
            Gestiona cobros, rutas y utilidades con precisión quirúrgica y en tiempo real.
          </p>
        </div>
      </div>

      <div class="w-full md:w-1/2 p-12 md:p-20 bg-white flex flex-col justify-center">
        <div class="mb-10 flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-8 bg-blue-600 rounded-full"></div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Acceso</h1>
                </div>
                <p class="text-slate-400 font-bold text-sm uppercase tracking-widest">Credenciales de Agente</p>
            </div>
            <div id="server-status" class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                <div class="w-2 h-2 rounded-full bg-slate-300 animate-pulse status-dot"></div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter status-text">Verificando...</span>
            </div>
        </div>

        <form class="space-y-6" id="loginForm">
          <div class="space-y-2">
            <label class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 ml-4">Identificador</label>
            <div class="relative group">
              <Icon name="lucide:user" class="absolute left-6 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition-colors" />
              <input 
                type="text" 
                id="username"
                name="username"
                placeholder="Nombre de usuario" 
                required
                class="w-full pl-14 pr-6 py-5 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-700 outline-none focus:bg-white focus:border-blue-600 transition-all placeholder:text-slate-300"
              />
            </div>
          </div>

          <div class="space-y-2">
            <div class="flex justify-between items-center px-4">
                <label class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Contraseña Secreta</label>
            </div>
            <div class="relative group">
              <Icon name="lucide:lock" class="absolute left-6 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-300 group-focus-within:text-blue-600 transition-colors" />
              <input 
                type="password" 
                id="password"
                name="password"
                placeholder="••••••••" 
                required
                class="w-full pl-14 pr-14 py-5 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-700 outline-none focus:bg-white focus:border-blue-600 transition-all placeholder:text-slate-300"
              />
            </div>
          </div>

          <div id="errorBox" class="hidden bg-red-50 text-red-600 p-4 rounded-xl text-[11px] font-black border border-red-100 animate-shake uppercase tracking-tight">
            <div class="flex items-center gap-2">
                <Icon name="lucide:alert-circle" class="w-4 h-4" />
                <p id="errorMsg"></p>
            </div>
          </div>

          <div class="pt-4">
            <button type="submit" id="submitBtn" class="w-full bg-slate-900 hover:bg-blue-600 text-white py-6 rounded-2xl font-black text-lg shadow-xl shadow-slate-200 transition-all active:scale-95 flex items-center justify-center gap-3 group">
              <span id="btnText">Entrar al Sistema</span>
              <Icon name="lucide:chevron-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform" />
            </button>
          </div>
        </form>

        <footer class="mt-12 pt-8 border-t border-slate-50 flex justify-between items-center">
            <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest">© 2024 CobroDigital</p>
            <div class="flex gap-4">
                <Icon name="lucide:shield-check" class="w-4 h-4 text-slate-200" />
                <Icon name="lucide:globe" class="w-4 h-4 text-slate-200" />
            </div>
        </footer>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('loginForm') as HTMLFormElement;
  const errorBox = document.getElementById('errorBox') as HTMLDivElement;
  const errorMsg = document.getElementById('errorMsg') as HTMLParagraphElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const btnText = document.getElementById('btnText') as HTMLSpanElement;

  // VERIFICADOR DE STATUS DEL SERVIDOR
  async function checkServer() {
    const dot = document.querySelector('.status-dot');
    const text = document.querySelector('.status-text');
    try {
        const res = await fetch('http://localhost:8000/clientes'); // Endpoint simple para ping
        if(res.ok) {
            dot.classList.remove('bg-slate-300', 'animate-pulse');
            dot.classList.add('bg-emerald-500');
            text.innerText = "Servidor Online";
            text.classList.replace('text-slate-400', 'text-emerald-600');
        }
    } catch (e) {
        dot.classList.remove('bg-slate-300', 'animate-pulse');
        dot.classList.add('bg-red-500');
        text.innerText = "Servidor Offline";
        text.classList.replace('text-slate-400', 'text-red-600');
    }
  }
  
  checkServer();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    submitBtn.disabled = true;
    btnText.innerText = "Autenticando...";
    errorBox.classList.add('hidden');

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('http://localhost:8000/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.detail || 'Credenciales Incorrectas');
      }

      localStorage.setItem('currentUser', JSON.stringify(result));

      // Redirigir siempre al dashboard (el dashboard ya maneja la vista por rol internamente)
      window.location.href = '/dashboard';

    } catch (err: any) {
      errorMsg.innerText = err.message;
      errorBox.classList.remove('hidden');
      btnText.innerText = "Entrar al Sistema";
      submitBtn.disabled = false;
    }
  });
</script>

<style>
  .animate-shake {
    animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
  }
  @keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
  }
</style>