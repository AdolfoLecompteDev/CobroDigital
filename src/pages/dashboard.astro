---
import Layout from '../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import ResumenRapido from '../components/ResumenRapido.astro'; 
---

<Layout title="Panel de Control - CobroDigital">
  <nav class="max-w-7xl mx-auto px-6 pt-8 flex justify-between items-center">
    <div id="user-tag" class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl border border-slate-100 shadow-sm">
        <div id="role-icon" class="w-2.5 h-2.5 rounded-full animate-pulse"></div>
        <span id="role-text" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Verificando...</span>
    </div>

    <button id="logout-btn" class="group flex items-center gap-2 text-slate-400 hover:text-red-500 font-black text-[10px] uppercase tracking-[0.2em] transition-all">
      <div class="bg-slate-100 group-hover:bg-red-50 p-2.5 rounded-xl transition-colors">
        <Icon name="lucide:log-out" class="w-4 h-4" />
      </div>
      Finalizar Sesión
    </button>
  </nav>

  <div class="max-w-7xl mx-auto px-6 py-10">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-8">
      <div>
        <h1 class="text-5xl font-black text-slate-900 tracking-tighter flex items-center gap-4">
          <div class="bg-blue-600 p-3 rounded-[1.2rem] shadow-lg shadow-blue-200">
            <Icon name="lucide:layout-grid" class="text-white w-7 h-7" /> 
          </div>
          Central
        </h1>
        <p class="text-slate-500 font-bold mt-2 ml-1 uppercase text-[9px] tracking-[0.3em]">Operaciones de Cartera en Tiempo Real</p>
      </div>
      
      <div class="flex flex-wrap gap-4">
        <a id="btn-nuevo-cobrador" href="/nuevo-cobrador" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-900 px-6 py-4 rounded-2xl font-black flex items-center gap-3 transition-all active:scale-95 text-xs uppercase tracking-widest group">
          <Icon name="lucide:shield-plus" class="w-4 h-4 text-blue-600" /> 
          Personal
        </a>

        <a href="/nuevo-cliente" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-3 shadow-xl shadow-blue-100 transition-all active:scale-95 text-xs uppercase tracking-widest group">
          <Icon name="lucide:plus-circle" class="w-5 h-5" /> 
          Registrar Crédito
        </a>
      </div>
    </div>

    <div id="stats-container" class="hidden mb-16 animate-in fade-in duration-1000">
      <div class="flex items-center gap-3 mb-6 pl-1">
        <div class="w-1.5 h-4 bg-emerald-500 rounded-full"></div>
        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Balance de Utilidades</h2>
      </div>
      <ResumenRapido />
    </div>

    <div id="cobradores-container" class="hidden mb-16">
        <div class="mb-6 flex items-center gap-3 pl-1">
            <div class="w-1.5 h-4 bg-blue-600 rounded-full"></div>
            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Cobradores en Ruta</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="lista-cobradores">
            </div>
    </div>

    <div class="mb-6 flex items-center justify-between px-1">
        <div class="flex items-center gap-3">
            <div class="w-1.5 h-4 bg-slate-800 rounded-full"></div>
            <h2 id="list-title" class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Cargando Cartera...</h2>
        </div>
        <div id="client-badge" class="hidden bg-blue-50 text-blue-600 text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-tighter border border-blue-100">
            0 Registros
        </div>
    </div>

    <div id="grid-clientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
        {[1,2,3,4,5,6,7,8].map(() => (
            <div class="bg-white h-64 rounded-[2rem] border border-slate-100 animate-pulse shadow-sm"></div>
        ))}
    </div>
  </div>
</Layout>

<script>
  const API_URL = 'https://cobrodigital.onrender.com';

  // 1. VERIFICACIÓN DE SEGURIDAD (EJECUCIÓN INMEDIATA)
  const session = localStorage.getItem('currentUser');
  
  if (!session || session === 'undefined' || session === 'null') {
    console.log("Sesión inválida, redirigiendo...");
    window.location.replace('/');
    // IMPORTANTE: Detenemos el hilo de ejecución
    window.stop(); 
  }

  // Si llegamos aquí, la sesión existe
  const user = JSON.parse(session || '{}');

  // 2. CONFIGURACIÓN DE UI
  function setupUI() {
    const roleText = document.getElementById('role-text');
    const roleIcon = document.getElementById('role-icon');
    const title = document.getElementById('list-title');
    const statsCont = document.getElementById('stats-container');
    const cobradoresCont = document.getElementById('cobradores-container');
    const btnCobrador = document.getElementById('btn-nuevo-cobrador');

    if (user.role === 'admin') {
      statsCont?.classList.remove('hidden');
      cobradoresCont?.classList.remove('hidden');
      btnCobrador?.classList.remove('hidden');
      if (roleText) roleText.innerText = "Admin Master";
      roleIcon?.classList.add('bg-emerald-500');
      if (title) title.innerText = "Cartera Global";
    } else {
      if (roleText) roleText.innerText = `Ruta: ${user.nombre || user.username}`;
      roleIcon?.classList.add('bg-blue-500');
      if (title) title.innerText = "Mi Listado de Cobro";
    }
  }

  // 3. OBTENCIÓN DE DATOS (SOLO SI HAY USUARIO)
  async function fetchData() {
    if (!user.username) return;

    const grid = document.getElementById('grid-clientes');

    try {
      const urlClientes = user.role === 'admin' 
        ? `${API_URL}/clientes` 
        : `${API_URL}/clientes?cobrador_id=${user.username}`;
      
      const [resClientes, resCobs] = await Promise.all([
        fetch(urlClientes),
        user.role === 'admin' ? fetch(`${API_URL}/cobradores`) : Promise.resolve(null)
      ]);

      if (!resClientes.ok) throw new Error("Error API");

      const clientes = await resClientes.json();
      renderClientes(clientes);

      if (resCobs && resCobs.ok) {
        const cobradores = await resCobs.json();
        renderCobradores(cobradores);
      }
    } catch (error) {
      console.error("Error cargando datos:", error);
      // Reintento más largo (10 seg) para no saturar si falla
      setTimeout(fetchData, 10000);
    }
  }

  // Funciones de Render (Mantén tus funciones renderClientes y renderCobradores aquí...)
  function renderClientes(lista) { /* ... tu código ... */ }
  function renderCobradores(lista) { /* ... tu código ... */ }

  // 4. LOGOUT SEGURO
  document.getElementById('logout-btn').onclick = () => {
    localStorage.removeItem('currentUser');
    localStorage.clear();
    window.location.replace('/');
  };

  // INICIO
  setupUI();
  fetchData();
</script>