---
import Layout from '../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import ResumenRapido from '../components/ResumenRapido.astro'; 
---

<Layout title="Panel de Control - CobroDigital">
  <nav class="max-w-7xl mx-auto px-6 pt-8 flex justify-between items-center">
    <div id="user-tag" class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl border border-slate-100 shadow-sm">
        <div id="role-icon" class="w-2.5 h-2.5 rounded-full animate-pulse"></div>
        <span id="role-text" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Verificando...</span>
    </div>

    <button id="logout-btn" class="group flex items-center gap-2 text-slate-400 hover:text-red-500 font-black text-[10px] uppercase tracking-[0.2em] transition-all">
      <div class="bg-slate-100 group-hover:bg-red-50 p-2.5 rounded-xl transition-colors">
        <Icon name="lucide:log-out" class="w-4 h-4" />
      </div>
      Finalizar Sesión
    </button>
  </nav>

  <div class="max-w-7xl mx-auto px-6 py-10">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-8">
      <div>
        <h1 class="text-5xl font-black text-slate-900 tracking-tighter flex items-center gap-4">
          <div class="bg-blue-600 p-3 rounded-[1.2rem] shadow-lg shadow-blue-200">
            <Icon name="lucide:layout-grid" class="text-white w-7 h-7" /> 
          </div>
          Central
        </h1>
        <p class="text-slate-500 font-bold mt-2 ml-1 uppercase text-[9px] tracking-[0.3em]">Operaciones de Cartera en Tiempo Real</p>
      </div>
      
      <div class="flex flex-wrap gap-4">
        <a id="btn-nuevo-cobrador" href="/nuevo-cobrador" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-900 px-6 py-4 rounded-2xl font-black flex items-center gap-3 transition-all active:scale-95 text-xs uppercase tracking-widest group">
          <Icon name="lucide:shield-plus" class="w-4 h-4 text-blue-600" /> 
          Personal
        </a>

        <a href="/nuevo-cliente" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-3 shadow-xl shadow-blue-100 transition-all active:scale-95 text-xs uppercase tracking-widest group">
          <Icon name="lucide:plus-circle" class="w-5 h-5" /> 
          Registrar Crédito
        </a>
      </div>
    </div>

    <div id="stats-container" class="hidden mb-16 animate-in fade-in duration-1000">
      <div class="flex items-center gap-3 mb-6 pl-1">
        <div class="w-1.5 h-4 bg-emerald-500 rounded-full"></div>
        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Balance de Utilidades</h2>
      </div>
      <ResumenRapido />
    </div>

    <div id="cobradores-container" class="hidden mb-16">
        <div class="mb-6 flex items-center gap-3 pl-1">
            <div class="w-1.5 h-4 bg-blue-600 rounded-full"></div>
            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Cobradores en Ruta</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="lista-cobradores">
            </div>
    </div>

    <div class="mb-6 flex items-center justify-between px-1">
        <div class="flex items-center gap-3">
            <div class="w-1.5 h-4 bg-slate-800 rounded-full"></div>
            <h2 id="list-title" class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Cargando Cartera...</h2>
        </div>
        <div id="client-badge" class="hidden bg-blue-50 text-blue-600 text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-tighter border border-blue-100">
            0 Registros
        </div>
    </div>

    <div id="grid-clientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
        {[1,2,3,4].map(() => (
            <div class="bg-white h-52 rounded-[2rem] border border-slate-100 animate-pulse"></div>
        ))}
    </div>
  </div>
</Layout>

<script>
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (!user) window.location.href = '/';

  const statsCont = document.getElementById('stats-container');
  const cobradoresCont = document.getElementById('cobradores-container');
  const btnCobrador = document.getElementById('btn-nuevo-cobrador');
  const grid = document.getElementById('grid-clientes');
  const title = document.getElementById('list-title');

  // UI Setup
  if (user.role === 'admin') {
    statsCont?.classList.remove('hidden');
    cobradoresCont?.classList.remove('hidden');
    btnCobrador?.classList.remove('hidden');
    document.getElementById('role-text').innerText = "Admin Master";
    document.getElementById('role-icon').classList.add('bg-emerald-500');
    title.innerText = "Cartera Global";
  } else {
    document.getElementById('role-text').innerText = `Ruta: ${user.nombre || user.username}`;
    document.getElementById('role-icon').classList.add('bg-blue-500');
    title.innerText = "Mi Listado de Cobro";
  }

  async function fetchData() {
    try {
      const urlClientes = user.role === 'admin' 
        ? 'http://localhost:8000/clientes' 
        : `http://localhost:8000/clientes?cobrador_id=${user.username}`;
      
      const [resClientes, resCobs] = await Promise.all([
        fetch(urlClientes),
        user.role === 'admin' ? fetch('http://localhost:8000/cobradores') : Promise.resolve(null)
      ]);

      const clientes = await resClientes.json();
      renderClientes(clientes);

      if (resCobs) {
        const cobradores = await resCobs.json();
        renderCobradores(cobradores);
      }
    } catch (error) {
      grid.innerHTML = `<div class="col-span-full text-center py-10 bg-red-50 rounded-3xl text-red-500 text-[10px] font-black uppercase tracking-widest">Error de Sincronización</div>`;
    }
  }

  function renderClientes(lista) {
    const badge = document.getElementById('client-badge');
    badge.innerText = `${lista.length} CLIENTES`;
    badge.classList.remove('hidden');

    grid.innerHTML = lista.map(c => `
      <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 hover:border-blue-500 hover:shadow-xl hover:shadow-blue-900/5 transition-all group flex flex-col justify-between min-h-[260px]">
        <div>
          <div class="flex justify-between items-start mb-4">
            <div class="bg-slate-50 text-slate-400 p-3 rounded-xl group-hover:bg-blue-600 group-hover:text-white transition-all duration-300">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="text-right">
              <p class="text-[8px] font-black text-slate-300 uppercase tracking-tighter">Cuota</p>
              <p class="text-sm font-black text-slate-900">$${(c.cuota || 0).toLocaleString()}</p>
            </div>
          </div>
          <h3 class="text-lg font-black text-slate-800 leading-tight mb-1 group-hover:text-blue-600 transition-colors">${c.nombre}</h3>
          <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight truncate">${c.barrio}</p>
        </div>

        <div class="mt-6 pt-4 border-t border-slate-50 flex items-end justify-between">
          <div>
            <p class="text-[8px] text-slate-300 uppercase font-black mb-1">Saldo</p>
            <p class="text-xl font-black text-slate-900">$${c.saldo.toLocaleString()}</p>
          </div>
          <a href="/cliente/${c.id}" class="bg-slate-900 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-blue-600 transition-all shadow-lg active:scale-90">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
          </a>
        </div>
      </div>
    `).join('');
  }

  function renderCobradores(lista) {
    const cont = document.getElementById('lista-cobradores');
    if (!cont) return;
    cont.innerHTML = lista.map(cob => `
      <a href="/cobrador/${cob.username}" class="bg-white rounded-2xl p-4 border border-slate-100 hover:border-blue-200 transition-all flex items-center gap-4 group">
        <div class="bg-blue-50 text-blue-600 p-2.5 rounded-xl group-hover:bg-blue-600 group-hover:text-white transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        </div>
        <div class="overflow-hidden">
          <p class="text-xs font-black text-slate-900 truncate">${cob.nombre}</p>
          <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${cob.zona || 'Sin Zona'}</p>
        </div>
      </a>
    `).join('');
  }

  document.getElementById('logout-btn').onclick = () => {
    localStorage.removeItem('currentUser');
    window.location.href = '/';
  };

  fetchData();
</script>